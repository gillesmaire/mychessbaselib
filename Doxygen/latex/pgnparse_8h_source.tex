\hypertarget{pgnparse_8h_source}{}\doxysection{pgnparse.\+h}
\mbox{\hyperlink{pgnparse_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * Copyright (C) 2018  Fulvio Benini}}
\DoxyCodeLine{3 \textcolor{comment}{ *}}
\DoxyCodeLine{4 \textcolor{comment}{ * This file is part of SCID (Shane's Chess Information Database).}}
\DoxyCodeLine{5 \textcolor{comment}{ *}}
\DoxyCodeLine{6 \textcolor{comment}{ * SCID is free software: you can redistribute it and/or modify}}
\DoxyCodeLine{7 \textcolor{comment}{ * it under the terms of the GNU General Public License as published by}}
\DoxyCodeLine{8 \textcolor{comment}{ * the Free Software Foundation.}}
\DoxyCodeLine{9 \textcolor{comment}{ *}}
\DoxyCodeLine{10 \textcolor{comment}{ * SCID is distributed in the hope that it will be useful,}}
\DoxyCodeLine{11 \textcolor{comment}{ * but WITHOUT ANY WARRANTY; without even the implied warranty of}}
\DoxyCodeLine{12 \textcolor{comment}{ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}}
\DoxyCodeLine{13 \textcolor{comment}{ * GNU General Public License for more details.}}
\DoxyCodeLine{14 \textcolor{comment}{ *}}
\DoxyCodeLine{15 \textcolor{comment}{ * You should have received a copy of the GNU General Public License}}
\DoxyCodeLine{16 \textcolor{comment}{ * along with SCID. If not, see <http://www.gnu.org/licenses/>.}}
\DoxyCodeLine{17 \textcolor{comment}{ *}}
\DoxyCodeLine{18 \textcolor{comment}{ */}}
\DoxyCodeLine{19 }
\DoxyCodeLine{24 \textcolor{preprocessor}{\#ifndef SCID\_PGNPARSE\_H}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#define SCID\_PGNPARSE\_H}}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{game_8h}{game.h}}"{}}}
\DoxyCodeLine{28 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{pgn__lexer_8h}{pgn\_lexer.h}}"{}}}
\DoxyCodeLine{29 \textcolor{preprocessor}{\#include <string>}}
\DoxyCodeLine{30 \textcolor{preprocessor}{\#include <string\_view>}}
\DoxyCodeLine{31 \textcolor{preprocessor}{\#include <vector>}}
\DoxyCodeLine{32 }
\DoxyCodeLine{39 \textcolor{keyword}{class }\mbox{\hyperlink{class_pgn_visitor}{PgnVisitor}} \{}
\DoxyCodeLine{40     \mbox{\hyperlink{class_game}{Game}}\& game;}
\DoxyCodeLine{41     std::vector<std::pair<size\_t, std::string>> errors\_;}
\DoxyCodeLine{42     \textcolor{keywordtype}{size\_t} linenum\_ = 0;}
\DoxyCodeLine{43     \textcolor{keywordtype}{int} nErrorsAllowed\_ = 2;}
\DoxyCodeLine{44 }
\DoxyCodeLine{45     \textcolor{keyword}{using }TView = std::pair<const char*, const char*>;}
\DoxyCodeLine{46     \textcolor{keyword}{friend} \textcolor{keyword}{struct }\mbox{\hyperlink{struct_pgn_parse_log}{PgnParseLog}};}
\DoxyCodeLine{47 }
\DoxyCodeLine{48 \textcolor{keyword}{public}:}
\DoxyCodeLine{49     \textcolor{keyword}{explicit} \mbox{\hyperlink{class_pgn_visitor_a7156e00598a5cc46aeb2ee8e2a4ff877}{PgnVisitor}}(\mbox{\hyperlink{class_game}{Game}}\& g) : game(g) \{\}}
\DoxyCodeLine{50 }
\DoxyCodeLine{51     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_pgn_visitor_aa7376268ebacbf33bff7d43d6cf81f84}{visitPGN\_inputEOF}}() \{}
\DoxyCodeLine{52         \textcolor{keywordflow}{if} (nErrorsAllowed\_)}
\DoxyCodeLine{53             logErr(\textcolor{stringliteral}{"{}Unexpected end of input (result missing ?)."{}});}
\DoxyCodeLine{54     \}}
\DoxyCodeLine{55 }
\DoxyCodeLine{56     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_pgn_visitor_af518cc3b74ff817e14310b74b951da5b}{visitPGN\_inputUnexpectedPGNHeader}}() \{}
\DoxyCodeLine{57         \textcolor{keywordflow}{if} (nErrorsAllowed\_)}
\DoxyCodeLine{58             logErr(\textcolor{stringliteral}{"{}Unexpected end of game: PGN header '[' seen "{}}}
\DoxyCodeLine{59                    \textcolor{stringliteral}{"{}inside game (result missing ?)."{}});}
\DoxyCodeLine{60     \}}
\DoxyCodeLine{61 }
\DoxyCodeLine{62     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_ad3cc8d2731c14b681cf9d7dea61ee676}{visitPGN\_Comment}}(TView comment) \{}
\DoxyCodeLine{63         \textcolor{keywordflow}{if} (nErrorsAllowed\_ < 0) \{ \textcolor{comment}{// Skip until the end of the game}}
\DoxyCodeLine{64             linenum\_ += std::count(comment.first, comment.second, \textcolor{charliteral}{'\(\backslash\)n'});}
\DoxyCodeLine{65             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{66         \}}
\DoxyCodeLine{67 }
\DoxyCodeLine{68         linenum\_ += \mbox{\hyperlink{namespacepgn_a4e6ca25094bbef4e4cf3239de1500616}{pgn::trim}}(comment);}
\DoxyCodeLine{69         \textcolor{keyword}{auto}\& str = game.\mbox{\hyperlink{class_game_aec54f242bf305b359c4bdbbb9c0f1c87}{accessMoveComment}}();}
\DoxyCodeLine{70         \textcolor{keyword}{auto} prevSz = str.size();}
\DoxyCodeLine{71         str.append(comment.first, comment.second);}
\DoxyCodeLine{72         linenum\_ += \mbox{\hyperlink{namespacepgn_a1e07b2abbe22fe845078799e17be260c}{pgn::normalize}}(str, prevSz);}
\DoxyCodeLine{73         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{74     \}}
\DoxyCodeLine{75 }
\DoxyCodeLine{76     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_a4dc966b45656bd663320376064f6eda5}{visitPGN\_EndOfLine}}() \{}
\DoxyCodeLine{77         ++linenum\_;}
\DoxyCodeLine{78         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{79     \}}
\DoxyCodeLine{80 }
\DoxyCodeLine{81     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_pgn_visitor_a75212432e88d2b3175ef8a215d39ae49}{visitPGN\_EPD}}(TView line) \{}
\DoxyCodeLine{82         \mbox{\hyperlink{common_8h_a79da58dac9dcdbcd4005f1d440e363ba}{ASSERT}}(nErrorsAllowed\_ >= 0);}
\DoxyCodeLine{83         std::string tmp(line.first, line.second);}
\DoxyCodeLine{84         \textcolor{keywordflow}{if} (game.\mbox{\hyperlink{class_game_a2bea4b77cc33866b26b5e435d6459733}{SetStartFen}}(tmp.c\_str()) == \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}}) \{}
\DoxyCodeLine{85             \textcolor{keyword}{auto} opcode = std::find\_if(}
\DoxyCodeLine{86                 line.first, line.second, [spaces = 0](\textcolor{keywordtype}{char} ch) \textcolor{keyword}{mutable} \{}
\DoxyCodeLine{87                     return (ch == \textcolor{stringliteral}{' '}) ? spaces++ == 4 : spaces == 4;}
\DoxyCodeLine{88                 \});}
\DoxyCodeLine{89             \mbox{\hyperlink{class_pgn_visitor_ad3cc8d2731c14b681cf9d7dea61ee676}{visitPGN\_Comment}}(std::make\_pair(opcode, line.second));}
\DoxyCodeLine{90         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{91             logFatalErr(\textcolor{stringliteral}{"{}Failed to parse EPD record: "{}}, line);}
\DoxyCodeLine{92         \}}
\DoxyCodeLine{93     \}}
\DoxyCodeLine{94 }
\DoxyCodeLine{95     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_a652cfb2feccef00d1fd2eda975aaf705}{visitPGN\_Escape}}(TView) \{ \textcolor{keywordflow}{return} \textcolor{keyword}{true}; \}}
\DoxyCodeLine{96 }
\DoxyCodeLine{97     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_a15459264340e4c67957c2599fc938ac0}{visitPGN\_MoveNum}}(TView) \{ \textcolor{keywordflow}{return} \textcolor{keyword}{true}; \}}
\DoxyCodeLine{98 }
\DoxyCodeLine{99     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_a3b390f2f215bd2bc45c57bee297c060e}{visitPGN\_NAG}}(TView token) \{}
\DoxyCodeLine{100         \textcolor{keywordflow}{if} (nErrorsAllowed\_ < 0) \textcolor{comment}{// Skip until the end of the game}}
\DoxyCodeLine{101             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{102 }
\DoxyCodeLine{103         \textcolor{keyword}{auto} nag\_code = \mbox{\hyperlink{game_8cpp_a534c67a00d26cb1a55e666d5464d0dd9}{game\_parseNag}}(token);}
\DoxyCodeLine{104         \textcolor{keywordflow}{if} (nag\_code == 0 || game.\mbox{\hyperlink{class_game_ad13bd27017142596d0458464ffd9f528}{AddNag}}(nag\_code) != \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}})}
\DoxyCodeLine{105             \textcolor{keywordflow}{return} logErr(\textcolor{stringliteral}{"{}Invalid annotation symbol: "{}}, token);}
\DoxyCodeLine{106 }
\DoxyCodeLine{107         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{108     \}}
\DoxyCodeLine{109 }
\DoxyCodeLine{110     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_pgn_visitor_adb9660e13d8a639dc0dbad17f59e7103}{visitPGN\_ResultFinal}}(\textcolor{keywordtype}{char} resultCh) \{}
\DoxyCodeLine{111         \textcolor{keyword}{auto} result = \mbox{\hyperlink{common_8h_aaa03fe46f271ad4574f8110cbce44b03}{RESULT\_None}};}
\DoxyCodeLine{112         \textcolor{keywordflow}{switch} (resultCh) \{}
\DoxyCodeLine{113         \textcolor{keywordflow}{case} \textcolor{charliteral}{'0'}:}
\DoxyCodeLine{114             result = \mbox{\hyperlink{common_8h_a9dd5d23bba9930f8ece6be3e7c18d0ad}{RESULT\_Black}};}
\DoxyCodeLine{115             \textcolor{keywordflow}{break};}
\DoxyCodeLine{116         \textcolor{keywordflow}{case} \textcolor{charliteral}{'1'}:}
\DoxyCodeLine{117             result = \mbox{\hyperlink{common_8h_a2203d77b39536657b0a7d765a990ef71}{RESULT\_White}};}
\DoxyCodeLine{118             \textcolor{keywordflow}{break};}
\DoxyCodeLine{119         \textcolor{keywordflow}{case} \textcolor{charliteral}{'/'}:}
\DoxyCodeLine{120             result = \mbox{\hyperlink{common_8h_a4946769bd12af555df43f7df4a071761}{RESULT\_Draw}};}
\DoxyCodeLine{121             \textcolor{keywordflow}{break};}
\DoxyCodeLine{122         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{123             \mbox{\hyperlink{common_8h_a79da58dac9dcdbcd4005f1d440e363ba}{ASSERT}}(resultCh == \textcolor{charliteral}{'*'});}
\DoxyCodeLine{124         \}}
\DoxyCodeLine{125 }
\DoxyCodeLine{126         \textcolor{keyword}{auto} prev\_result = game.\mbox{\hyperlink{class_game_a1a9be841cbf4753af1bba1425cbb6621}{GetResult}}();}
\DoxyCodeLine{127         \textcolor{keywordflow}{if} (result != prev\_result) \{}
\DoxyCodeLine{128             \textcolor{comment}{// Use the end-\/of-\/game result instead of the header tag result}}
\DoxyCodeLine{129             game.\mbox{\hyperlink{class_game_a47b11225a3ddee558e8437159bd14d5d}{SetResult}}(result);}
\DoxyCodeLine{130             \textcolor{keywordflow}{if} (prev\_result != \mbox{\hyperlink{common_8h_aaa03fe46f271ad4574f8110cbce44b03}{RESULT\_None}} \&\& nErrorsAllowed\_ >= 0)}
\DoxyCodeLine{131                 logErr(\textcolor{stringliteral}{"{}Final result did not match the header tag."{}});}
\DoxyCodeLine{132         \}}
\DoxyCodeLine{133     \}}
\DoxyCodeLine{134 }
\DoxyCodeLine{135     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_a260f61fdf964d8f2fa66c79f9a806ce6}{visitPGN\_SANMove}}(TView tok) \{}
\DoxyCodeLine{136         \textcolor{keywordflow}{if} (nErrorsAllowed\_ < 0) \textcolor{comment}{// Skip until the end of the game}}
\DoxyCodeLine{137             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{138 }
\DoxyCodeLine{139         \mbox{\hyperlink{structsimple_move_t}{simpleMoveT}} sm;}
\DoxyCodeLine{140         \textcolor{keyword}{auto} err = game.\mbox{\hyperlink{class_game_ac2e435ef0edddf8878b710e6b160dc3a}{GetCurrentPos}}()-\/>\mbox{\hyperlink{class_position_aeb7b7f8a06e5dc8e451982babb380668}{ParseMove}}(\&sm, tok.first, tok.second);}
\DoxyCodeLine{141         \textcolor{keywordflow}{if} (err != \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}}) \{}
\DoxyCodeLine{142             \textcolor{keywordflow}{if} (\mbox{\hyperlink{game_8cpp_a534c67a00d26cb1a55e666d5464d0dd9}{game\_parseNag}}(tok)) \textcolor{comment}{// may be 'D', 'N' or a weird suffix}}
\DoxyCodeLine{143                 \textcolor{keywordflow}{return} \mbox{\hyperlink{class_pgn_visitor_a3b390f2f215bd2bc45c57bee297c060e}{visitPGN\_NAG}}(tok);}
\DoxyCodeLine{144 }
\DoxyCodeLine{145             \textcolor{keywordflow}{return} logFatalErr(\textcolor{stringliteral}{"{}Failed to parse the move: "{}}, tok);}
\DoxyCodeLine{146         \}}
\DoxyCodeLine{147         \textcolor{keywordflow}{return} (game.\mbox{\hyperlink{class_game_a841f5222632c5dc9955404585183e526}{AddMove}}(sm) == \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}})}
\DoxyCodeLine{148                    ? true}
\DoxyCodeLine{149                    : logFatalErr(\textcolor{stringliteral}{"{}Failed to add the move: "{}}, tok);}
\DoxyCodeLine{150     \}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_aa765ce620bb0617ffd213d8a27725f46}{visitPGN\_Suffix}}(TView token) \{ \textcolor{keywordflow}{return} \mbox{\hyperlink{class_pgn_visitor_a3b390f2f215bd2bc45c57bee297c060e}{visitPGN\_NAG}}(token); \}}
\DoxyCodeLine{153 }
\DoxyCodeLine{154     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_ae3ffb25286605899ce04e722c0be2171}{visitPGN\_TagPair}}(TView tag, TView value) \{}
\DoxyCodeLine{155         linenum\_ += std::count(value.first, value.second, \textcolor{charliteral}{'\(\backslash\)n'});}
\DoxyCodeLine{156         \textcolor{keywordflow}{if} (nErrorsAllowed\_ < 0) \textcolor{comment}{// Skip until the end of the game}}
\DoxyCodeLine{157             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{158 }
\DoxyCodeLine{159         \textcolor{keyword}{auto} tagLen = std::distance(tag.first, tag.second);}
\DoxyCodeLine{160         \textcolor{keyword}{auto} valueLen = std::distance(value.first, value.second);}
\DoxyCodeLine{161         \textcolor{keywordflow}{if} (tagLen == 0 || tagLen + valueLen > 240 ||}
\DoxyCodeLine{162             !parseTagPair(tag.first, tagLen, value)) \textcolor{comment}{// Failure}}
\DoxyCodeLine{163         \{}
\DoxyCodeLine{164             \textcolor{keyword}{const} \textcolor{keyword}{auto} tag\_sv = std::string\_view(tag.first, tagLen);}
\DoxyCodeLine{165             \textcolor{keyword}{const} \textcolor{keyword}{auto} value\_sv = std::string\_view(value.first, valueLen);}
\DoxyCodeLine{166             std::string tag\_parsed;}
\DoxyCodeLine{167             std::string value\_parsed;}
\DoxyCodeLine{168             game.\mbox{\hyperlink{class_game_a38f3ff0dac3aec0fe6f8d72029796e0c}{viewTagPairs}}([\&](\textcolor{keyword}{auto} game\_tag, \textcolor{keyword}{auto} game\_value) \{}
\DoxyCodeLine{169                 \textcolor{keywordflow}{if} (tag\_sv == game\_tag) \{}
\DoxyCodeLine{170                     tag\_parsed = game\_tag;}
\DoxyCodeLine{171                     value\_parsed = game\_value;}
\DoxyCodeLine{172                 \}}
\DoxyCodeLine{173             \});}
\DoxyCodeLine{174             \textcolor{keywordflow}{if} (tag\_sv != tag\_parsed || value\_sv != value\_parsed) \{}
\DoxyCodeLine{175                 std::string err(tag\_sv);}
\DoxyCodeLine{176                 err.append(\textcolor{stringliteral}{"{} \(\backslash\)"{}"{}});}
\DoxyCodeLine{177                 err.append(value\_sv);}
\DoxyCodeLine{178                 err.append(\textcolor{stringliteral}{"{}\(\backslash\)"{} ==> "{}});}
\DoxyCodeLine{179                 err.append(tag\_parsed);}
\DoxyCodeLine{180                 err.append(\textcolor{stringliteral}{"{} \(\backslash\)"{}"{}});}
\DoxyCodeLine{181                 err.append(value\_parsed);}
\DoxyCodeLine{182                 err.push\_back(\textcolor{charliteral}{'"{}'});}
\DoxyCodeLine{183                 logWarning(\textcolor{stringliteral}{"{}Error parsing the tag pair: "{}},}
\DoxyCodeLine{184                            \{err.c\_str(), err.c\_str() + err.size()\});}
\DoxyCodeLine{185             \}}
\DoxyCodeLine{186         \}}
\DoxyCodeLine{187         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{188     \}}
\DoxyCodeLine{189 }
\DoxyCodeLine{190     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_af2826e11ddb8b408787f8143bb005836}{visitPGN\_Unknown}}(TView token) \{}
\DoxyCodeLine{191         \textcolor{keywordflow}{if} (nErrorsAllowed\_ < 0) \textcolor{comment}{// Skip until the end of the game}}
\DoxyCodeLine{192             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{193 }
\DoxyCodeLine{194         \textcolor{comment}{// Accept misspelled castling moves}}
\DoxyCodeLine{195         std::string tmp(token.first, token.second);}
\DoxyCodeLine{196         \textcolor{keywordflow}{if} (tmp == \textcolor{stringliteral}{"{}0-\/0"{}} || tmp == \textcolor{stringliteral}{"{}00"{}}) \{}
\DoxyCodeLine{197             tmp = \textcolor{stringliteral}{"{}O-\/O"{}};}
\DoxyCodeLine{198             \textcolor{keywordflow}{return} \mbox{\hyperlink{class_pgn_visitor_a260f61fdf964d8f2fa66c79f9a806ce6}{visitPGN\_SANMove}}(\{tmp.c\_str(), tmp.c\_str() + 3\});}
\DoxyCodeLine{199         \}}
\DoxyCodeLine{200         \textcolor{keywordflow}{if} (tmp == \textcolor{stringliteral}{"{}0-\/0-\/0"{}} || tmp == \textcolor{stringliteral}{"{}000"{}}) \{}
\DoxyCodeLine{201             tmp = \textcolor{stringliteral}{"{}O-\/O-\/O"{}};}
\DoxyCodeLine{202             \textcolor{keywordflow}{return} \mbox{\hyperlink{class_pgn_visitor_a260f61fdf964d8f2fa66c79f9a806ce6}{visitPGN\_SANMove}}(\{tmp.c\_str(), tmp.c\_str() + 5\});}
\DoxyCodeLine{203         \}}
\DoxyCodeLine{204 }
\DoxyCodeLine{205         \textcolor{keywordflow}{return} logErr(\textcolor{stringliteral}{"{}Unknown token: "{}}, token);}
\DoxyCodeLine{206     \}}
\DoxyCodeLine{207 }
\DoxyCodeLine{208     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_a426f6a074f86d302477f13aff933ce85}{visitPGN\_VariationStart}}() \{}
\DoxyCodeLine{209         \textcolor{keywordflow}{if} (nErrorsAllowed\_ < 0) \textcolor{comment}{// Skip until the end of the game}}
\DoxyCodeLine{210             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{211 }
\DoxyCodeLine{212         \textcolor{keywordflow}{if} (game.\mbox{\hyperlink{class_game_a0e436b84436ed2b919dc11820f6ded86}{AddVariation}}() != \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}})}
\DoxyCodeLine{213             \textcolor{keywordflow}{return} logFatalErr(\textcolor{stringliteral}{"{}Failed to add a new variation."{}});}
\DoxyCodeLine{214 }
\DoxyCodeLine{215         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{216     \}}
\DoxyCodeLine{217 }
\DoxyCodeLine{218     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_pgn_visitor_a4e53fa8d8fa3cf792b199ccf49b162cb}{visitPGN\_VariationEnd}}() \{}
\DoxyCodeLine{219         \textcolor{keywordflow}{if} (nErrorsAllowed\_ < 0) \textcolor{comment}{// Skip until the end of the game}}
\DoxyCodeLine{220             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{221 }
\DoxyCodeLine{222         \textcolor{keywordflow}{if} (game.\mbox{\hyperlink{class_game_a6ee576646ff11f2ab0e227c68bf97ed8}{MoveExitVariation}}() != \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}} || game.\mbox{\hyperlink{class_game_a52dccd9ad98ffa40c523768840b14a87}{MoveForward}}() != \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}})}
\DoxyCodeLine{223             \textcolor{keywordflow}{return} logFatalErr(\textcolor{stringliteral}{"{}Failed to exit from variation."{}});}
\DoxyCodeLine{224 }
\DoxyCodeLine{225         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{226     \}}
\DoxyCodeLine{227 }
\DoxyCodeLine{228 \textcolor{keyword}{private}:}
\DoxyCodeLine{229     \textcolor{keywordtype}{bool} logWarning(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* str1, TView str2 = \{\textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}\}) \{}
\DoxyCodeLine{230         errors\_.emplace\_back(linenum\_, str1);}
\DoxyCodeLine{231         \textcolor{keywordflow}{if} (std::distance(str2.first, str2.second) > 200) \{}
\DoxyCodeLine{232             errors\_.back().second.append(str2.first, 200);}
\DoxyCodeLine{233             errors\_.back().second.append(\textcolor{stringliteral}{"{}..."{}});}
\DoxyCodeLine{234         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{235             errors\_.back().second.append(str2.first, str2.second);}
\DoxyCodeLine{236         \}}
\DoxyCodeLine{237         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{238     \}}
\DoxyCodeLine{239 }
\DoxyCodeLine{240     \textcolor{keywordtype}{bool} logErr(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* str1, TView str2 = \{\textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}\}) \{}
\DoxyCodeLine{241         -\/-\/nErrorsAllowed\_;}
\DoxyCodeLine{242         \textcolor{keywordflow}{return} logWarning(str1, str2);}
\DoxyCodeLine{243     \}}
\DoxyCodeLine{244 }
\DoxyCodeLine{245     \textcolor{keywordtype}{bool} logFatalErr(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* str1, TView str2 = \{\textcolor{keyword}{nullptr}, \textcolor{keyword}{nullptr}\}) \{}
\DoxyCodeLine{246         nErrorsAllowed\_ = 0;}
\DoxyCodeLine{247         \textcolor{keywordflow}{return} logErr(str1, str2);}
\DoxyCodeLine{248     \}}
\DoxyCodeLine{249 }
\DoxyCodeLine{250     \textcolor{keywordtype}{bool} parseTagResult(TView str) \{}
\DoxyCodeLine{251         \textcolor{keyword}{auto} len = std::distance(str.first, str.second);}
\DoxyCodeLine{252         \textcolor{keywordflow}{if} (len > 0 \&\& *str.first == \textcolor{charliteral}{'*'}) \{}
\DoxyCodeLine{253             game.\mbox{\hyperlink{class_game_a47b11225a3ddee558e8437159bd14d5d}{SetResult}}(\mbox{\hyperlink{common_8h_aaa03fe46f271ad4574f8110cbce44b03}{RESULT\_None}});}
\DoxyCodeLine{254             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{255         \}}
\DoxyCodeLine{256         \textcolor{keywordflow}{if} (len >= 3) \{}
\DoxyCodeLine{257             \textcolor{keywordflow}{if} (std::equal(str.first, str.first + 3, \textcolor{stringliteral}{"{}1-\/0"{}})) \{}
\DoxyCodeLine{258                 game.\mbox{\hyperlink{class_game_a47b11225a3ddee558e8437159bd14d5d}{SetResult}}(\mbox{\hyperlink{common_8h_a2203d77b39536657b0a7d765a990ef71}{RESULT\_White}});}
\DoxyCodeLine{259                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{260             \}}
\DoxyCodeLine{261             \textcolor{keywordflow}{if} (std::equal(str.first, str.first + 3, \textcolor{stringliteral}{"{}0-\/1"{}})) \{}
\DoxyCodeLine{262                 game.\mbox{\hyperlink{class_game_a47b11225a3ddee558e8437159bd14d5d}{SetResult}}(\mbox{\hyperlink{common_8h_a9dd5d23bba9930f8ece6be3e7c18d0ad}{RESULT\_Black}});}
\DoxyCodeLine{263                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{264             \}}
\DoxyCodeLine{265             \textcolor{keywordflow}{if} (std::equal(str.first, str.first + 3, \textcolor{stringliteral}{"{}1/2"{}})) \{}
\DoxyCodeLine{266                 game.\mbox{\hyperlink{class_game_a47b11225a3ddee558e8437159bd14d5d}{SetResult}}(\mbox{\hyperlink{common_8h_a4946769bd12af555df43f7df4a071761}{RESULT\_Draw}});}
\DoxyCodeLine{267                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{268             \}}
\DoxyCodeLine{269         \}}
\DoxyCodeLine{270         \textcolor{keywordflow}{return} logErr(\textcolor{stringliteral}{"{}Invalid Result tag: "{}}, str);}
\DoxyCodeLine{271     \}}
\DoxyCodeLine{272 }
\DoxyCodeLine{273     \textcolor{keywordtype}{bool} parseTagPair(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* tag, \textcolor{keywordtype}{size\_t} tagLen, TView value) \{}
\DoxyCodeLine{274         \textcolor{keywordflow}{switch} (tagLen) \{}
\DoxyCodeLine{275         \textcolor{keywordflow}{case} 3:}
\DoxyCodeLine{276             \textcolor{keywordflow}{if} (std::equal(tag, tag + 3, \textcolor{stringliteral}{"{}ECO"{}})) \{}
\DoxyCodeLine{277                 std::string tmp\{value.first, value.second\};}
\DoxyCodeLine{278                 game.\mbox{\hyperlink{class_game_a8e24253996747cd5c60e0e0644cd7ac0}{SetEco}}(\mbox{\hyperlink{misc_8cpp_a4babf7ee1b4b32490a857ab2af374916}{eco\_FromString}}(tmp.c\_str()));}
\DoxyCodeLine{279                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{280             \}}
\DoxyCodeLine{281             \textcolor{keywordflow}{if} (std::equal(tag, tag + 3, \textcolor{stringliteral}{"{}FEN"{}})) \{}
\DoxyCodeLine{282                 std::string tmp\{value.first, value.second\};}
\DoxyCodeLine{283                 \textcolor{keywordflow}{return} game.\mbox{\hyperlink{class_game_a2bea4b77cc33866b26b5e435d6459733}{SetStartFen}}(tmp.c\_str()) == \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}};}
\DoxyCodeLine{284             \}}
\DoxyCodeLine{285             \textcolor{keywordflow}{break};}
\DoxyCodeLine{286         \textcolor{keywordflow}{case} 4:}
\DoxyCodeLine{287             \textcolor{keywordflow}{if} (std::equal(tag, tag + 4, \textcolor{stringliteral}{"{}Date"{}})) \{}
\DoxyCodeLine{288                 \textcolor{keyword}{const} \textcolor{keyword}{auto} date = \mbox{\hyperlink{date_8h_a0963f675bee026f75e2d069e6e1fa691}{date\_parsePGNTag}}(value);}
\DoxyCodeLine{289                 game.\mbox{\hyperlink{class_game_a6d52ec74f229fd81500a4789b050008b}{SetDate}}(date);}
\DoxyCodeLine{290                 \textcolor{keywordflow}{return} !\mbox{\hyperlink{date_8h_a02340a455066307d94bcc92bfb663736}{date\_isPartial}}(date);}
\DoxyCodeLine{291             \}}
\DoxyCodeLine{292             \textcolor{keywordflow}{break};}
\DoxyCodeLine{293         \textcolor{keywordflow}{case} 6:}
\DoxyCodeLine{294             \textcolor{keywordflow}{if} (std::equal(tag, tag + 6, \textcolor{stringliteral}{"{}Result"{}}))}
\DoxyCodeLine{295                 \textcolor{keywordflow}{return} parseTagResult(value);}
\DoxyCodeLine{296             \textcolor{keywordflow}{break};}
\DoxyCodeLine{297         \textcolor{keywordflow}{case} 7:}
\DoxyCodeLine{298             \textcolor{keywordflow}{if} (std::equal(tag, tag + 7, \textcolor{stringliteral}{"{}UTCDate"{}}) \&\&}
\DoxyCodeLine{299                 game.\mbox{\hyperlink{class_game_a49af503593042b44d5b58625a90862b1}{GetDate}}() == \mbox{\hyperlink{date_8h_a595f5d8135194ea54a673ed64c126f9c}{ZERO\_DATE}}) \{}
\DoxyCodeLine{300                 \textcolor{comment}{// Add two tags: "{}UTCDate"{} and the standard "{}Date"{}.}}
\DoxyCodeLine{301                 \textcolor{keyword}{const} \textcolor{keyword}{auto} date = \mbox{\hyperlink{date_8h_a0963f675bee026f75e2d069e6e1fa691}{date\_parsePGNTag}}(value);}
\DoxyCodeLine{302                 \textcolor{keywordflow}{if} (!\mbox{\hyperlink{date_8h_a02340a455066307d94bcc92bfb663736}{date\_isPartial}}(date))}
\DoxyCodeLine{303                     game.\mbox{\hyperlink{class_game_a6d52ec74f229fd81500a4789b050008b}{SetDate}}(date);}
\DoxyCodeLine{304             \}}
\DoxyCodeLine{305             \textcolor{keywordflow}{break};}
\DoxyCodeLine{306         \textcolor{keywordflow}{case} 9:}
\DoxyCodeLine{307             \textcolor{keywordflow}{if} (std::equal(tag, tag + 9, \textcolor{stringliteral}{"{}EventDate"{}})) \{}
\DoxyCodeLine{308                 \textcolor{keyword}{const} \textcolor{keyword}{auto} date = \mbox{\hyperlink{date_8h_a0963f675bee026f75e2d069e6e1fa691}{date\_parsePGNTag}}(value);}
\DoxyCodeLine{309                 game.\mbox{\hyperlink{class_game_a64d903eb991c7d6df944fe69d1f5fb3f}{SetEventDate}}(date);}
\DoxyCodeLine{310                 \textcolor{keywordflow}{return} !\mbox{\hyperlink{date_8h_a02340a455066307d94bcc92bfb663736}{date\_isPartial}}(date);}
\DoxyCodeLine{311             \}}
\DoxyCodeLine{312             \textcolor{keywordflow}{if} (std::equal(tag, tag + 9, \textcolor{stringliteral}{"{}ScidFlags"{}})) \{}
\DoxyCodeLine{313                 game.\mbox{\hyperlink{class_game_a2f066547b3489d022bed58318adf6a10}{SetScidFlags}}(value.first,}
\DoxyCodeLine{314                                   std::distance(value.first, value.second));}
\DoxyCodeLine{315                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{316             \}}
\DoxyCodeLine{317             \textcolor{keywordflow}{break};}
\DoxyCodeLine{318         \}}
\DoxyCodeLine{319         \textcolor{keywordflow}{if} (tagLen >= 8) \{}
\DoxyCodeLine{320             \textcolor{comment}{// Look for Rating Types: only the first Rating type found for}}
\DoxyCodeLine{321             \textcolor{comment}{// each player is added as the rating. Any extra ratings are}}
\DoxyCodeLine{322             \textcolor{comment}{// just added as normal tags.}}
\DoxyCodeLine{323             \textcolor{keywordflow}{if} (std::equal(tag, tag + 5, \textcolor{stringliteral}{"{}White"{}}) \&\& game.\mbox{\hyperlink{class_game_a579d8da19debf86c1f17043f1af926ce}{GetWhiteElo}}() == 0) \{}
\DoxyCodeLine{324                 \textcolor{keyword}{auto} res = game.\mbox{\hyperlink{class_game_ac047a1e84c3cfd72fb13c6ca4e715ab0}{setRating}}(\mbox{\hyperlink{board__def_8h_a4bd880125e6b5752a709bfa88f07e378}{WHITE}}, tag + 5, tagLen -\/ 5, value);}
\DoxyCodeLine{325                 \textcolor{keywordflow}{if} (res >= 0)}
\DoxyCodeLine{326                     \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{327             \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (std::equal(tag, tag + 5, \textcolor{stringliteral}{"{}Black"{}}) \&\&}
\DoxyCodeLine{328                        game.\mbox{\hyperlink{class_game_a87b4111f2435376b380177cc401fb97a}{GetBlackElo}}() == 0) \{}
\DoxyCodeLine{329                 \textcolor{keyword}{auto} res = game.\mbox{\hyperlink{class_game_ac047a1e84c3cfd72fb13c6ca4e715ab0}{setRating}}(\mbox{\hyperlink{board__def_8h_addf5ded2624a6c91f0e0509a3ccb3ea7}{BLACK}}, tag + 5, tagLen -\/ 5, value);}
\DoxyCodeLine{330                 \textcolor{keywordflow}{if} (res >= 0)}
\DoxyCodeLine{331                     \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{332             \}}
\DoxyCodeLine{333         \}}
\DoxyCodeLine{334         \textcolor{comment}{// The c++20 \{value.first, value.second\} fails on AppleClang13}}
\DoxyCodeLine{335         \textcolor{keywordtype}{size\_t} valueLen = std::distance(value.first, value.second);}
\DoxyCodeLine{336         \textcolor{keyword}{auto}\& str = game.\mbox{\hyperlink{class_game_ab01af8ef1ce6d49f2f9be15a9b3c8335}{addTag}}(\{tag, tagLen\}, \{value.first, valueLen\});}
\DoxyCodeLine{337         linenum\_ += pgn::normalize<true>(str, 0);}
\DoxyCodeLine{338         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{339     \}}
\DoxyCodeLine{340 \};}
\DoxyCodeLine{341 }
\DoxyCodeLine{345 \textcolor{keyword}{struct }\mbox{\hyperlink{struct_pgn_parse_log}{PgnParseLog}} \{}
\DoxyCodeLine{346     std::string \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}};}
\DoxyCodeLine{347     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \mbox{\hyperlink{struct_pgn_parse_log_af975229e71611d8f6e6b42a8ee17060f}{n\_bytes}} = 0;}
\DoxyCodeLine{348     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \mbox{\hyperlink{struct_pgn_parse_log_afa9e0977d0ac8c7a549bae2b77438f35}{n\_lines}} = 0;}
\DoxyCodeLine{349     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \mbox{\hyperlink{struct_pgn_parse_log_ab6a9586a0609a82c815d69d0d5002b3b}{n\_games}} = 0;}
\DoxyCodeLine{350 }
\DoxyCodeLine{356     \textcolor{keywordtype}{bool} \mbox{\hyperlink{struct_pgn_parse_log_aca0cc2baaf3ee3a64284831ee523c069}{logGame}}(\textcolor{keywordtype}{size\_t} nBytes, \textcolor{keyword}{const} \mbox{\hyperlink{class_pgn_visitor}{PgnVisitor}}\& visitor) \{}
\DoxyCodeLine{357         ++\mbox{\hyperlink{struct_pgn_parse_log_ab6a9586a0609a82c815d69d0d5002b3b}{n\_games}};}
\DoxyCodeLine{358         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}\& e : visitor.errors\_) \{}
\DoxyCodeLine{359             \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}} += \textcolor{stringliteral}{"{}(game "{}} + std::to\_string(\mbox{\hyperlink{struct_pgn_parse_log_ab6a9586a0609a82c815d69d0d5002b3b}{n\_games}});}
\DoxyCodeLine{360             \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}} += \textcolor{stringliteral}{"{}, line "{}} + std::to\_string(\mbox{\hyperlink{struct_pgn_parse_log_afa9e0977d0ac8c7a549bae2b77438f35}{n\_lines}} + e.first) + \textcolor{stringliteral}{"{}) "{}};}
\DoxyCodeLine{361             \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}} += e.second;}
\DoxyCodeLine{362             \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}} += \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{363         \}}
\DoxyCodeLine{364         \mbox{\hyperlink{struct_pgn_parse_log_afa9e0977d0ac8c7a549bae2b77438f35}{n\_lines}} += visitor.linenum\_;}
\DoxyCodeLine{365         \mbox{\hyperlink{struct_pgn_parse_log_af975229e71611d8f6e6b42a8ee17060f}{n\_bytes}} += nBytes;}
\DoxyCodeLine{366         \textcolor{keywordflow}{if} (visitor.nErrorsAllowed\_ < 0) \{}
\DoxyCodeLine{367             \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}} += \textcolor{stringliteral}{"{}(game "{}} + std::to\_string(\mbox{\hyperlink{struct_pgn_parse_log_ab6a9586a0609a82c815d69d0d5002b3b}{n\_games}});}
\DoxyCodeLine{368             \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}} += \textcolor{stringliteral}{"{}, line "{}} + std::to\_string(\mbox{\hyperlink{struct_pgn_parse_log_afa9e0977d0ac8c7a549bae2b77438f35}{n\_lines}}) + \textcolor{stringliteral}{"{}) "{}};}
\DoxyCodeLine{369             \mbox{\hyperlink{struct_pgn_parse_log_ae090a7b2721fb337134812b79d2f6c03}{log}} += \textcolor{stringliteral}{"{}End of game, ignored the part after the last error.\(\backslash\)n"{}};}
\DoxyCodeLine{370             \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{371         \}}
\DoxyCodeLine{372         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{373     \}}
\DoxyCodeLine{374 \};}
\DoxyCodeLine{375 }
\DoxyCodeLine{387 \textcolor{keyword}{inline} \textcolor{keywordtype}{bool} \mbox{\hyperlink{pgnparse_8h_ae349d71e091033342a437d9458231a76}{pgnParseGame}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* input, \textcolor{keywordtype}{size\_t} inputLen, \mbox{\hyperlink{class_game}{Game}}\& game,}
\DoxyCodeLine{388                          \mbox{\hyperlink{struct_pgn_parse_log}{PgnParseLog}}\& log) \{}
\DoxyCodeLine{389     \textcolor{keyword}{struct }VisitorNoEOF : \textcolor{keyword}{public} \mbox{\hyperlink{class_pgn_visitor}{PgnVisitor}} \{}
\DoxyCodeLine{390         \textcolor{keyword}{explicit} VisitorNoEOF(\mbox{\hyperlink{class_game}{Game}}\& g) : \mbox{\hyperlink{class_pgn_visitor_a7156e00598a5cc46aeb2ee8e2a4ff877}{PgnVisitor}}(g) \{\}}
\DoxyCodeLine{391         \textcolor{keywordtype}{void} \mbox{\hyperlink{class_pgn_visitor_aa7376268ebacbf33bff7d43d6cf81f84}{visitPGN\_inputEOF}}() \{\}}
\DoxyCodeLine{392     \} visitor(game);}
\DoxyCodeLine{393 }
\DoxyCodeLine{394     \textcolor{keyword}{auto} parse = \mbox{\hyperlink{namespacepgn_a98ee346a4a45c134c03aca8e18027a10}{pgn::parse\_game}}(\{input, input + inputLen\}, visitor);}
\DoxyCodeLine{395     \textcolor{keywordflow}{if} (!log.\mbox{\hyperlink{struct_pgn_parse_log_aca0cc2baaf3ee3a64284831ee523c069}{logGame}}(parse.first, visitor))}
\DoxyCodeLine{396         \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{397 }
\DoxyCodeLine{398     \textcolor{keywordflow}{if} (parse.first == inputLen \&\& !parse.second \&\&}
\DoxyCodeLine{399         *game.\mbox{\hyperlink{class_game_a9205ae9a0a505e635ca347b409ecc5bf}{GetMoveComment}}() == \textcolor{charliteral}{'\(\backslash\)0'})}
\DoxyCodeLine{400         \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{401 }
\DoxyCodeLine{402     \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{403 \}}
\DoxyCodeLine{404 }
\DoxyCodeLine{405 \textcolor{preprocessor}{\#endif }\textcolor{comment}{// idndef SCID\_PGNPARSE\_H}}

\end{DoxyCode}

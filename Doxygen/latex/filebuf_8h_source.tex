\hypertarget{filebuf_8h_source}{}\doxysection{filebuf.\+h}
\mbox{\hyperlink{filebuf_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * Copyright (C) 2014-\/2017  Fulvio Benini}}
\DoxyCodeLine{3 \textcolor{comment}{}}
\DoxyCodeLine{4 \textcolor{comment}{ * This file is part of Scid (Shane's Chess Information Database).}}
\DoxyCodeLine{5 \textcolor{comment}{ *}}
\DoxyCodeLine{6 \textcolor{comment}{ * Scid is free software: you can redistribute it and/or modify}}
\DoxyCodeLine{7 \textcolor{comment}{ * it under the terms of the GNU General Public License as published by}}
\DoxyCodeLine{8 \textcolor{comment}{ * the Free Software Foundation.}}
\DoxyCodeLine{9 \textcolor{comment}{ *}}
\DoxyCodeLine{10 \textcolor{comment}{ * Scid is distributed in the hope that it will be useful,}}
\DoxyCodeLine{11 \textcolor{comment}{ * but WITHOUT ANY WARRANTY; without even the implied warranty of}}
\DoxyCodeLine{12 \textcolor{comment}{ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}}
\DoxyCodeLine{13 \textcolor{comment}{ * GNU General Public License for more details.}}
\DoxyCodeLine{14 \textcolor{comment}{ *}}
\DoxyCodeLine{15 \textcolor{comment}{ * You should have received a copy of the GNU General Public License}}
\DoxyCodeLine{16 \textcolor{comment}{ * along with Scid.  If not, see <http://www.gnu.org/licenses/>.}}
\DoxyCodeLine{17 \textcolor{comment}{ */}}
\DoxyCodeLine{18 }
\DoxyCodeLine{23 \textcolor{preprocessor}{\#ifndef FILEBUF\_H}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#define FILEBUF\_H}}
\DoxyCodeLine{25 }
\DoxyCodeLine{26 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{common_8h}{common.h}}"{}}}
\DoxyCodeLine{27 \textcolor{preprocessor}{\#include <climits>}}
\DoxyCodeLine{28 \textcolor{preprocessor}{\#include <fstream>}}
\DoxyCodeLine{29 }
\DoxyCodeLine{35 \textcolor{keyword}{class }\mbox{\hyperlink{class_filebuf}{Filebuf}} : \textcolor{keyword}{public} std::filebuf \{}
\DoxyCodeLine{36 \textcolor{keyword}{public}:}
\DoxyCodeLine{43     \mbox{\hyperlink{error_8h_a3d30ac5665bf72ba7258c90866c775c0}{errorT}} \mbox{\hyperlink{class_filebuf_a3104b2ca3d08dc1beb23bc88d0016232}{Open}}(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* filename, \mbox{\hyperlink{common_8h_a68bff708b2e6f80e37e6294782b291e1}{fileModeT}} fmode) \{}
\DoxyCodeLine{44         std::ios::openmode mode = std::ios::binary;}
\DoxyCodeLine{45         \textcolor{keywordflow}{switch} (fmode) \{}
\DoxyCodeLine{46         \textcolor{keywordflow}{case} \mbox{\hyperlink{common_8h_a68bff708b2e6f80e37e6294782b291e1a250dac90cf2b4769b5a917c55cae8788}{FMODE\_ReadOnly}}:}
\DoxyCodeLine{47             mode |= std::ios::in;}
\DoxyCodeLine{48             \textcolor{keywordflow}{break};}
\DoxyCodeLine{49         \textcolor{keywordflow}{case} \mbox{\hyperlink{common_8h_a68bff708b2e6f80e37e6294782b291e1af6c5155cf88504f8758d3c5ebdfe17aa}{FMODE\_WriteOnly}}:}
\DoxyCodeLine{50             mode |= std::ios::out;}
\DoxyCodeLine{51             \textcolor{keywordflow}{break};}
\DoxyCodeLine{52         \textcolor{keywordflow}{case} \mbox{\hyperlink{common_8h_a68bff708b2e6f80e37e6294782b291e1a976d2cfdaf957bbde8ce832ae3bd2b58}{FMODE\_Both}}:}
\DoxyCodeLine{53             mode |= std::ios::in | std::ios::out;}
\DoxyCodeLine{54             \textcolor{keywordflow}{break};}
\DoxyCodeLine{55         \textcolor{keywordflow}{case} \mbox{\hyperlink{common_8h_a68bff708b2e6f80e37e6294782b291e1a0e2d884279c8f8d4bc987e8d6e9f20ba}{FMODE\_Create}}:}
\DoxyCodeLine{56             mode |= std::ios::in | std::ios::out | std::ios::trunc;}
\DoxyCodeLine{57             \textcolor{keywordflow}{break};}
\DoxyCodeLine{58         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{59             \textcolor{keywordflow}{return} \mbox{\hyperlink{error_8h_a6010858fa50d5a3a113c2fa9ce6d3fe7}{ERROR\_FileMode}};}
\DoxyCodeLine{60         \}}
\DoxyCodeLine{61 }
\DoxyCodeLine{62         \textcolor{keywordflow}{return} (open(filename, mode) != 0) ? \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}} : \mbox{\hyperlink{error_8h_a5556811f4fbef9102f895fca624ecf13}{ERROR\_FileOpen}};}
\DoxyCodeLine{63     \}}
\DoxyCodeLine{64 }
\DoxyCodeLine{86     \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{class_filebuf_a14551221dc1d8520bd39b94ba8d978c9}{getline}}(\textcolor{keywordtype}{char}* str, \textcolor{keywordtype}{size\_t} count) \{}
\DoxyCodeLine{87         \mbox{\hyperlink{common_8h_a79da58dac9dcdbcd4005f1d440e363ba}{ASSERT}}(str != 0);}
\DoxyCodeLine{88         \mbox{\hyperlink{common_8h_a79da58dac9dcdbcd4005f1d440e363ba}{ASSERT}}(count != 0);}
\DoxyCodeLine{89 }
\DoxyCodeLine{90         \textcolor{keywordtype}{size\_t} n = 0;}
\DoxyCodeLine{91         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} ch = sgetc(); ch != EOF; ch = snextc()) \{}
\DoxyCodeLine{92             ++n;}
\DoxyCodeLine{93             \textcolor{keywordflow}{if} (ch == \textcolor{charliteral}{'\(\backslash\)n'}) \{}
\DoxyCodeLine{94                 sbumpc();}
\DoxyCodeLine{95                 \textcolor{keywordflow}{break};}
\DoxyCodeLine{96             \}}
\DoxyCodeLine{97             \textcolor{keywordflow}{if} (n >= count) \{}
\DoxyCodeLine{98                 n = 0; \textcolor{comment}{// Fail: buffer too small}}
\DoxyCodeLine{99                 \textcolor{keywordflow}{break};}
\DoxyCodeLine{100             \}}
\DoxyCodeLine{101             *str++ = \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{char}\textcolor{keyword}{>}(ch);}
\DoxyCodeLine{102         \}}
\DoxyCodeLine{103         *str = 0;}
\DoxyCodeLine{104         \textcolor{keywordflow}{return} n;}
\DoxyCodeLine{105     \}}
\DoxyCodeLine{106 }
\DoxyCodeLine{111     \textcolor{keywordtype}{byte} \mbox{\hyperlink{class_filebuf_a4a635289d674ca4caee1a50762f3331d}{ReadOneByte}}() \{ \textcolor{keywordflow}{return} \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(sbumpc()); \}}
\DoxyCodeLine{112 }
\DoxyCodeLine{117     uint16\_t \mbox{\hyperlink{class_filebuf_a6a349600489402d9216f46533fb1d9de}{ReadTwoBytes}}() \{ \textcolor{keywordflow}{return} \textcolor{keyword}{static\_cast<}uint16\_t\textcolor{keyword}{>}(read<2>()); \}}
\DoxyCodeLine{118 }
\DoxyCodeLine{123     uint32\_t \mbox{\hyperlink{class_filebuf_a0698032dc0a33d7b5ee05c7b2049dcb1}{ReadThreeBytes}}() \{ \textcolor{keywordflow}{return} read<3>(); \}}
\DoxyCodeLine{124 }
\DoxyCodeLine{129     uint32\_t \mbox{\hyperlink{class_filebuf_a5cd01e7891ec8ef147fa219939b3dc95}{ReadFourBytes}}() \{ \textcolor{keywordflow}{return} read<4>(); \}}
\DoxyCodeLine{130 }
\DoxyCodeLine{135     \textcolor{keywordtype}{int} \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keywordtype}{byte} value) \{}
\DoxyCodeLine{136         int\_type ch = sputc(\textcolor{keyword}{static\_cast<}char\_type\textcolor{keyword}{>}(value));}
\DoxyCodeLine{137         \textcolor{keywordflow}{return} (ch != traits\_type::eof()) ? 1 : 0;}
\DoxyCodeLine{138     \}}
\DoxyCodeLine{139 }
\DoxyCodeLine{144     \textcolor{keywordtype}{int} \mbox{\hyperlink{class_filebuf_a9b626fe362c98720bdd61487e730fe30}{WriteTwoBytes}}(uint32\_t value) \{}
\DoxyCodeLine{145         \textcolor{keywordflow}{return} \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value >> 8)) +}
\DoxyCodeLine{146                \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value));}
\DoxyCodeLine{147     \}}
\DoxyCodeLine{152     \textcolor{keywordtype}{int} \mbox{\hyperlink{class_filebuf_aea174a5b493f68d0fed1bf57b3aac249}{WriteThreeBytes}}(uint32\_t value) \{}
\DoxyCodeLine{153         \textcolor{keywordflow}{return} \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value >> 16)) +}
\DoxyCodeLine{154                \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value >> 8)) +}
\DoxyCodeLine{155                \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value));}
\DoxyCodeLine{156     \}}
\DoxyCodeLine{161     \textcolor{keywordtype}{int} \mbox{\hyperlink{class_filebuf_ac5a23d3dfeb5960bfdf562470ab16b23}{WriteFourBytes}}(uint32\_t value) \{}
\DoxyCodeLine{162         \textcolor{keywordflow}{return} \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value >> 24)) +}
\DoxyCodeLine{163                \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value >> 16)) +}
\DoxyCodeLine{164                \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value >> 8)) +}
\DoxyCodeLine{165                \mbox{\hyperlink{class_filebuf_a53787afd5276d9674b0bd1c8253b077c}{WriteOneByte}}(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{byte}\textcolor{keyword}{>}(value));}
\DoxyCodeLine{166     \}}
\DoxyCodeLine{167 }
\DoxyCodeLine{168 \textcolor{keyword}{private}:}
\DoxyCodeLine{169     \textcolor{keyword}{template} <\textcolor{keywordtype}{int} nBytes> uint32\_t read() \{}
\DoxyCodeLine{170         uint32\_t res = 0;}
\DoxyCodeLine{171         \textcolor{keywordflow}{if} (nBytes > 3)}
\DoxyCodeLine{172             res += \textcolor{keyword}{static\_cast<}uint32\_t\textcolor{keyword}{>}(\mbox{\hyperlink{class_filebuf_a4a635289d674ca4caee1a50762f3331d}{ReadOneByte}}()) << 24;}
\DoxyCodeLine{173         \textcolor{keywordflow}{if} (nBytes > 2)}
\DoxyCodeLine{174             res += \textcolor{keyword}{static\_cast<}uint32\_t\textcolor{keyword}{>}(\mbox{\hyperlink{class_filebuf_a4a635289d674ca4caee1a50762f3331d}{ReadOneByte}}()) << 16;}
\DoxyCodeLine{175         \textcolor{keywordflow}{if} (nBytes > 1)}
\DoxyCodeLine{176             res += \textcolor{keyword}{static\_cast<}uint32\_t\textcolor{keyword}{>}(\mbox{\hyperlink{class_filebuf_a4a635289d674ca4caee1a50762f3331d}{ReadOneByte}}()) << 8;}
\DoxyCodeLine{177         \textcolor{keywordflow}{return} res + \mbox{\hyperlink{class_filebuf_a4a635289d674ca4caee1a50762f3331d}{ReadOneByte}}();}
\DoxyCodeLine{178     \}}
\DoxyCodeLine{179 \};}
\DoxyCodeLine{180 }
\DoxyCodeLine{184 \textcolor{keyword}{class }\mbox{\hyperlink{class_filebuf_append}{FilebufAppend}} : \textcolor{keyword}{protected} \mbox{\hyperlink{class_filebuf}{Filebuf}} \{}
\DoxyCodeLine{185     std::streamoff fileSz\_;}
\DoxyCodeLine{186     std::streamoff filePos\_;}
\DoxyCodeLine{187 }
\DoxyCodeLine{188 \textcolor{keyword}{public}:}
\DoxyCodeLine{189     \mbox{\hyperlink{class_filebuf_append_aeac509c12fe0f5a847e1a2655d79cabc}{FilebufAppend}}() : fileSz\_(0), filePos\_(-\/1) \{\}}
\DoxyCodeLine{190 }
\DoxyCodeLine{197     \mbox{\hyperlink{error_8h_a3d30ac5665bf72ba7258c90866c775c0}{errorT}} \mbox{\hyperlink{class_filebuf_append_ad5bfb07ac62a96eb2dfacb22a80f31bd}{open}}(\textcolor{keyword}{const} std::string\& filename, \mbox{\hyperlink{common_8h_a68bff708b2e6f80e37e6294782b291e1}{fileModeT}} fmode) \{}
\DoxyCodeLine{198         \mbox{\hyperlink{error_8h_a3d30ac5665bf72ba7258c90866c775c0}{errorT}} res = \mbox{\hyperlink{class_filebuf_a3104b2ca3d08dc1beb23bc88d0016232}{Open}}(filename.c\_str(), fmode);}
\DoxyCodeLine{199         \textcolor{keywordflow}{if} (res != \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}})}
\DoxyCodeLine{200             \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{201         fileSz\_ = pubseekoff(0, std::ios::end);}
\DoxyCodeLine{202         \textcolor{keywordflow}{if} (fileSz\_ == -\/1)}
\DoxyCodeLine{203             \textcolor{keywordflow}{return} \mbox{\hyperlink{error_8h_abdeda0173dc99c36efcb5c34286a65c3}{ERROR\_FileSeek}};}
\DoxyCodeLine{204         \textcolor{keywordflow}{return} \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}};}
\DoxyCodeLine{205     \}}
\DoxyCodeLine{206 }
\DoxyCodeLine{210     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} \mbox{\hyperlink{class_filebuf_append_a624cd84c55089c76400d7dd1e996964c}{size}}()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} fileSz\_; \}}
\DoxyCodeLine{211 }
\DoxyCodeLine{216     \textcolor{keywordtype}{int} \mbox{\hyperlink{class_filebuf_append_af17ccf399f8c1f3916314435a7f8a36e}{pubsync}}() \{ \textcolor{keywordflow}{return} sync(); \}}
\DoxyCodeLine{217 }
\DoxyCodeLine{223     \mbox{\hyperlink{error_8h_a3d30ac5665bf72ba7258c90866c775c0}{errorT}} \mbox{\hyperlink{class_filebuf_append_ab5bdd89607d420ba77d087794a5c1136}{append}}(\textcolor{keyword}{const} char\_type* s, std::streamsize count) \{}
\DoxyCodeLine{224         assert(s != 0);}
\DoxyCodeLine{225 }
\DoxyCodeLine{226         \textcolor{keywordflow}{if} (filePos\_ != -\/2) \{ \textcolor{comment}{// Seek to end of file, if necessary.}}
\DoxyCodeLine{227             filePos\_ = seekpos(fileSz\_);}
\DoxyCodeLine{228             \textcolor{keywordflow}{if} (filePos\_ == -\/1)}
\DoxyCodeLine{229                 \textcolor{keywordflow}{return} \mbox{\hyperlink{error_8h_abdeda0173dc99c36efcb5c34286a65c3}{ERROR\_FileSeek}};}
\DoxyCodeLine{230             filePos\_ = -\/2;}
\DoxyCodeLine{231         \}}
\DoxyCodeLine{232 }
\DoxyCodeLine{233         std::streamsize n = xsputn(s, count);}
\DoxyCodeLine{234         fileSz\_ += n;}
\DoxyCodeLine{235         \textcolor{keywordflow}{return} (n == count) ? \mbox{\hyperlink{error_8h_a97c1af1656bc9df70e86ab103915c98a}{OK}} : \mbox{\hyperlink{error_8h_ab13779c6cb65867602cfa92c27d6d659}{ERROR\_FileWrite}};}
\DoxyCodeLine{236     \}}
\DoxyCodeLine{237 }
\DoxyCodeLine{241     \textcolor{keyword}{auto} \mbox{\hyperlink{class_filebuf_append_a862d9d3648e35cd8dfc8b5b4fa3d9d7b}{sbumpc}}() \{}
\DoxyCodeLine{242         \textcolor{keyword}{auto} res = std::filebuf::sbumpc();}
\DoxyCodeLine{243         \textcolor{keywordflow}{if} (res != Filebuf::traits\_type::eof())}
\DoxyCodeLine{244             ++filePos\_;}
\DoxyCodeLine{245 }
\DoxyCodeLine{246         \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{247     \}}
\DoxyCodeLine{248 }
\DoxyCodeLine{252     std::streamsize \mbox{\hyperlink{class_filebuf_append_a58b16d816e9fa4795fb2072a80ba9fdd}{sgetn}}(char\_type* s, std::streamsize count) \{}
\DoxyCodeLine{253         std::streamsize res = xsgetn(s, count);}
\DoxyCodeLine{254         filePos\_ += res;}
\DoxyCodeLine{255         \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{256     \}}
\DoxyCodeLine{257 }
\DoxyCodeLine{263     std::streamoff \mbox{\hyperlink{class_filebuf_append_ac58a66252c857f417be2eb86e9001963}{pubseekpos}}(std::streamoff pos) \{}
\DoxyCodeLine{264         \textcolor{keywordflow}{if} (filePos\_ < 0 || pos < filePos\_)}
\DoxyCodeLine{265             \textcolor{keywordflow}{return} filePos\_ = seekpos(pos);}
\DoxyCodeLine{266 }
\DoxyCodeLine{267         \textcolor{keywordflow}{if} (filePos\_ != pos) \{}
\DoxyCodeLine{268             \textcolor{keyword}{const} std::streamsize avail = egptr() -\/ gptr();}
\DoxyCodeLine{269             \textcolor{keywordflow}{if} (avail >= pos -\/ filePos\_) \{}
\DoxyCodeLine{270                 \mbox{\hyperlink{common_8h_a79da58dac9dcdbcd4005f1d440e363ba}{ASSERT}}(pos -\/ filePos\_ <= INT\_MAX);}
\DoxyCodeLine{271                 gbump(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(pos -\/ filePos\_));}
\DoxyCodeLine{272                 filePos\_ = pos;}
\DoxyCodeLine{273             \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{274                 filePos\_ = seekpos(pos);}
\DoxyCodeLine{275             \}}
\DoxyCodeLine{276         \}}
\DoxyCodeLine{277         \textcolor{keywordflow}{return} filePos\_;}
\DoxyCodeLine{278     \}}
\DoxyCodeLine{279 \};}
\DoxyCodeLine{280 }
\DoxyCodeLine{281 \textcolor{preprocessor}{\#endif }\textcolor{comment}{// FILEBUF\_H}}

\end{DoxyCode}
